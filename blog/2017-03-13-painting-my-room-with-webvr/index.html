<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Intro This month im moving to a new house, and one of the questions that came out was &ldquo;Which color should i paint the walls?&rdquo;. I thought it would be nice to have some kind of &ldquo;prototype&rdquo; in which i could see how good selection a color would be. I inmediatly remembered that Aframe its the new hot topic, and with a panorama photo, you could see it in 360 degress." />
    <meta property="og:site_name" content="Federico Scodelaro" />
    <meta property="og:title" content="Painting my room with WebVR | Federico Scodelaro"/>
    <meta property="og:description" content="Intro This month im moving to a new house, and one of the questions that came out was &ldquo;Which color should i paint the walls?&rdquo;. I thought it would be nice to have some kind of &ldquo;prototype&rdquo; in which i could see how good selection a color would be. I inmediatly remembered that Aframe its the new hot topic, and with a panorama photo, you could see it in 360 degress." />
    <meta property="og:image" content="https://pudymody.github.io/static/me.jpg" />
    <meta property="og:url" content="https://pudymody.github.io/blog/2017-03-13-painting-my-room-with-webvr/" >
    <meta property="og:type" content="blog" />
    
      <meta property="article:published_time" content="2017-03-13 00:00:00 &#43;0000 UTC">
    
    <title>Painting my room with WebVR | Federico Scodelaro</title>
    <link rel="stylesheet" href="https://pudymody.github.io/static/tufte.min.css" />
    <link rel="shortcut icon" href="https://pudymody.github.io/static/favicon.png" type="image/png">
    <link rel="alternate" type="application/rss+xml" title="RSS" href="https://pudymody.github.io/index.xml">
  </head>

  <body>
    <header>
      <nav>
        <ul>
          
          
          <li>
            <a href="https://pudymody.github.io/">/home/federico scodelaro</a>
          </li>
          -
          <li>
            <a target="_blank" rel="noopener" href="https://github.com/pudymody">Github</a>
          </li>
          -
          <li>
            <a target="_blank" rel="noopener" href="https://telegram.me/pudymody">Telegram</a>
          </li>
          -
          <li>
            <a target="_blank" rel="noopener" href="mailto:federicoscodelaro@gmail.com">Email</a>
          </li>
          -
          

          
          
          <li>
            <a href="/index.xml">~/subscribe</a>
          </li>
          
        </ul>
      </nav>
    </header>
    <article>

<section>
<h1>Painting my room with WebVR</h1>
<p class="subtitle">2017/03/13</p>


<nav id="TableOfContents">
<ul>
<li><a href="#intro">Intro</a>
<ul>
<li><a href="#getting-the-walls-separately">Getting the walls separately</a></li>
<li><a href="#skeleton-and-dependencies">Skeleton and dependencies</a></li>
<li><a href="#application-code">Application code</a></li>
<li><a href="#worker-code">Worker code</a></li>
<li><a href="#final-thoughts">Final thoughts</a></li>
</ul></li>
</ul>
</nav>




<h1 id="intro">Intro</h1>

<p>This month im moving to a new house, and one of the questions that came out was &ldquo;<em>Which color should i paint the walls?</em>&rdquo;. I thought it would be nice to have some kind of &ldquo;prototype&rdquo; in which i could see how good selection a color would be. I inmediatly remembered that <a href="https://aframe.io">Aframe</a> its the new hot topic, and with a panorama photo, you could see it in 360 degress. So i decided to bake this prototype which you could see a working example <a href="https://pudymody.github.io/aframe-room-painter/">here</a>, watch a video <a href="https://www.youtube.com/watch?v=LQ3nlGC_uYE">here</a> or if you like reading source code without explanation, <a href="https://github.com/pudymody/aframe-room-painter">here</a>. (<em>That&rsquo;s not actually part of my house because i couldnt take any equirectangular photo, but at least i have a cool prototype working</em>)</p>

<h2 id="getting-the-walls-separately">Getting the walls separately</h2>

<p>The first step was to get an image who works as a 360 degreess image with Aframe, thats a equirectangular photo. Im going to use the following.</p>

<p><img src="4.jpg" alt="Image" /></p>

<p>The next step was to get some kind of reference for every wall that we want to paint, so i made a transparent image with the same size, but with the actual wall being referenced colored in pure green, some kind of &ldquo;chroma key&rdquo; but only for the wall</p>

<p><img src="0.png" alt="Image" />
<img src="1.png" alt="Image" />
<img src="2.png" alt="Image" />
<img src="3.png" alt="Image" /></p>

<p>For this example, i ended with 5 images, the actual equirectangular image, and four more one for each wall.</p>

<h2 id="skeleton-and-dependencies">Skeleton and dependencies</h2>

<p>First, we create a file called <em>index.html</em> with a simple HTML5 template, and inside our <em>body</em> we insert the following</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html">&lt;script type=<span style="color:#a31515">&#34;text/javascript&#34;</span> src=<span style="color:#a31515">&#34;assets/dat.gui.js&#34;</span>&gt;&lt;/script&gt;
&lt;script src=<span style="color:#a31515">&#34;https://aframe.io/releases/0.3.2/aframe.min.js&#34;</span>&gt;&lt;/script&gt;
&lt;script src=<span style="color:#a31515">&#34;assets/app.js&#34;</span>&gt;&lt;/script&gt;</code></pre></div>
<ul>
<li><p><a href="https://github.com/dataarts/dat.gui">dat.gui</a>: Provides a gui to control js object propertys</p></li>

<li><p><a href="https://aframe.io">aframe</a>: Aframe library</p></li>

<li><p>app.js: Our main app</p></li>
</ul>

<h2 id="application-code">Application code</h2>

<p>First, we need to load the images, and paint them to a canvas. To do this im going to use the <em>fetch</em>, to load them, then im going to create a bitmap representation with the <em>createImageBitmap</em> call, and after that, im going to paint that bitmap to a canvas, everything with the new promise ways. We also make an array of those promises.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#00f">function</span> ImageBitmapToCanvas( imgBitmap ){
    <span style="color:#00f">var</span> $canvas = document.createElement(<span style="color:#a31515">&#39;canvas&#39;</span>);
        $canvas.width = imgBitmap.width;
        $canvas.height = imgBitmap.height;

    <span style="color:#00f">var</span> $ctx = $canvas.getContext(<span style="color:#a31515">&#39;2d&#39;</span>);
        $ctx.drawImage( imgBitmap, 0, 0 );

        <span style="color:#00f">return</span> $canvas;
}

<span style="color:#00f">var</span> Load = [<span style="color:#a31515">&#34;img/img.jpg&#34;</span>,<span style="color:#a31515">&#34;img/01.png&#34;</span>, <span style="color:#a31515">&#34;img/02.png&#34;</span>, <span style="color:#a31515">&#34;img/03.png&#34;</span>, <span style="color:#a31515">&#34;img/04.png&#34;</span>].map(<span style="color:#00f">function</span>( item ){
    <span style="color:#00f">return</span> fetch(item)
        .then( r =&gt; r.blob() )
        .then( createImageBitmap )
        .then( ImageBitmapToCanvas );
});
</code></pre></div>
<p>After every image is loaded, we store our full image for future uses, loop through each &ldquo;chroma wall&rdquo; to get and store its imageData, an array filled with four values, rgba, so we can manipulate its color. We create a gui controller to select each color, and we tell our worker to call the <em>setup</em> action. In case of any error, we log the output to the console, its just a prototype.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js">Promise.all(Load)
    .then(<span style="color:#00f">function</span>( canvases ){
        Handler._canvas = canvases[0];

        <span style="color:#00f">var</span> WallData = canvases.slice(1).map(<span style="color:#00f">function</span>( wall ){
            <span style="color:#00f">return</span> wall.getContext(<span style="color:#a31515">&#39;2d&#39;</span>).getImageData(0, 0, wall.width, wall.height);
        });

        <span style="color:#00f">var</span> i = 0, l = WallData.length;
        <span style="color:#00f">for</span>( ; i &lt; l; i++){
            colors[<span style="color:#a31515">&#34;color&#34;</span> + i] = { r : 0, g : 255, b : 0 };
            gui.addColor(colors, <span style="color:#a31515">&#34;color&#34;</span> + i);
        }

        worker.postMessage({
            action : <span style="color:#a31515">&#39;SETUP&#39;</span>,
            data : WallData
        });
    })
    .<span style="color:#00f">catch</span>( console.error );
</code></pre></div>
<p>If you are asking why im using a worker, the answer is because dealing with big immages and lots of lots of pixels, its some heavy computing stuff and i dont want to block the UI, so i prefer to spawn another process for this. But for now, lets explain how we deal with its communication.
First we create a new worker with the <em>worker.js</em> file, and when a new message is received, we check if the <em>Hanfler</em> object has the method <em>action</em>, if it has it, we call it with the data passed. Currently, in the main thread, we only have one method, update, which is responsible of showing the final image.
First, we make a copy of our main image canvas object, get its 2d context and set its composite method to multiply, thats where almost all the magic happens, the colors of the chroma pages blends making you get a guess of how everything could look. Then we loop through each updatedWalls object, which is a imageData object, make a canvas out of it, and paints it to the main cloned canvas. Finally, we get a blob out of this canvas, creates a url for it, and calls the <em>makeScene</em> method with it. Which is going to append the <strong>a-frame</strong> tags needed.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#00f">function</span> ImageDataToCanvas(data){
    <span style="color:#00f">var</span> $internalCanvas = document.createElement(<span style="color:#a31515">&#39;canvas&#39;</span>);
        $internalCanvas.width = data.width;
        $internalCanvas.height = data.height;

    <span style="color:#00f">var</span> $internalCtx = $internalCanvas.getContext(<span style="color:#a31515">&#39;2d&#39;</span>);
        $internalCtx.putImageData( data, 0, 0 );

    <span style="color:#00f">return</span> $internalCanvas
}

<span style="color:#00f">function</span> cloneCanvas(oldCanvas) {

    <span style="color:#00f">var</span> newCanvas = document.createElement(<span style="color:#a31515">&#39;canvas&#39;</span>);
    <span style="color:#00f">var</span> context = newCanvas.getContext(<span style="color:#a31515">&#39;2d&#39;</span>);

    newCanvas.width = oldCanvas.width;
    newCanvas.height = oldCanvas.height;

    context.drawImage(oldCanvas, 0, 0);

    <span style="color:#00f">return</span> newCanvas;
}

<span style="color:#00f">function</span> makeScene( url ){
    <span style="color:#00f">var</span> Scene = document.createElement(<span style="color:#a31515">&#39;a-scene&#39;</span>);
    <span style="color:#00f">var</span> Sky = document.createElement(<span style="color:#a31515">&#39;a-sky&#39;</span>);
        Sky.setAttribute(<span style="color:#a31515">&#39;src&#39;</span>, url);
        Sky.setAttribute(<span style="color:#a31515">&#39;rotation&#39;</span>, <span style="color:#a31515">&#39;0 -130 0&#39;</span>);

    Scene.appendChild(Sky);
    document.body.appendChild(Scene);
}

<span style="color:#00f">var</span> worker = <span style="color:#00f">new</span> Worker(<span style="color:#a31515">&#39;worker.js&#39;</span>);
worker.addEventListener(<span style="color:#a31515">&#39;message&#39;</span>, <span style="color:#00f">function</span>( evt ){
    <span style="color:#00f">var</span> data = evt.data;
    <span style="color:#00f">if</span>( Handler.hasOwnProperty( data.action ) ){
        Handler[ data.action ].call(Handler, data.data);
    }
})

<span style="color:#00f">var</span> Handler = {
    _canvas : [],
    UPDATE : <span style="color:#00f">function</span>( updatedWalls ){
        <span style="color:#00f">var</span> newCanvas = cloneCanvas(<span style="color:#00f">this</span>._canvas);
        <span style="color:#00f">var</span> $ctx = newCanvas.getContext(<span style="color:#a31515">&#39;2d&#39;</span>);
            $ctx.globalCompositeOperation = <span style="color:#a31515">&#34;multiply&#34;</span>;


        updatedWalls
            .map( ImageDataToCanvas )
            .forEach(<span style="color:#00f">function</span>( wall ){
                $ctx.drawImage(wall, 0, 0);
            });

        newCanvas.toBlob(<span style="color:#00f">function</span>( blob ){
            <span style="color:#00f">var</span> url = URL.createObjectURL(blob);
            makeScene(url);
        })
    }
};
</code></pre></div>
<p>Finally, we also need a function to delete the scene, and to create the controls of the ui. I think this are pretty straight forward to explain.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#00f">var</span> colors = {};
<span style="color:#00f">var</span> gui = <span style="color:#00f">new</span> dat.gui.GUI();
    gui.remember(colors);
    gui.__save_row.addEventListener(<span style="color:#a31515">&#39;click&#39;</span>, <span style="color:#00f">function</span>( evt ){
        <span style="color:#00f">if</span>( evt.target.className === <span style="color:#a31515">&#34;button save&#34;</span> ){
            <span style="color:#00f">var</span> newColors = Object.keys(colors).sort().map(<span style="color:#00f">function</span>( key ){
                <span style="color:#00f">return</span> colors[key];
            });

            worker.postMessage({
                action : <span style="color:#a31515">&#39;UPDATE&#39;</span>,
                data : newColors
            });
        }
    })

	document.addEventListener(<span style="color:#a31515">&#39;keyup&#39;</span>, <span style="color:#00f">function</span>(evt){
	    <span style="color:#00f">if</span>( evt.keyCode == 27 ){
	        destroyScene();
	    }
	})

	<span style="color:#00f">function</span> destroyScene(){
	    <span style="color:#00f">var</span> Sky = document.querySelector(<span style="color:#a31515">&#39;a-sky&#39;</span>);
	    <span style="color:#00f">var</span> Scene = document.querySelector(<span style="color:#a31515">&#39;a-scene&#39;</span>);

	    <span style="color:#00f">if</span>( Scene ){
	        URL.revokeObjectURL( Sky.getAttribute(<span style="color:#a31515">&#39;src&#39;</span>) );
	        Scene.parentNode.removeChild(Scene)
	    }
	}
</code></pre></div>
<h2 id="worker-code">Worker code</h2>

<p>And this is where all the magic of turning green walls to other colors happens. The communication way its the same. The setup method only stores the data received, which is an array of imageDatas. The update method is where everything happens, it receievs an array with the new colors. It loops through each imageData stored, get the color with the same index, creates a new <em>Uint8ClampedArray</em>, used to create a new imageData, and loop through the original. If its a pure green (0,255,0), changes it to the color wanted, and then return the new one. After all, call the <em>update</em> method in the client with the new imageDatas.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#00f">var</span> Handler = {
    _DATA : [],

    SETUP : <span style="color:#00f">function</span>( data ){
        <span style="color:#00f">this</span>._DATA = data;
    },

    UPDATE : <span style="color:#00f">function</span>( colors ){
        console.log(<span style="color:#a31515">&#34;[WORKER] Start new update&#34;</span>);
        <span style="color:#00f">var</span> returnData = <span style="color:#00f">this</span>._DATA.map(<span style="color:#00f">function</span>( item, index ){

            console.log(<span style="color:#a31515">&#34;[WORKER][WALL&#34;</span>+index+<span style="color:#a31515">&#34;] Start painting&#34;</span>);
            <span style="color:#00f">var</span> newColor = colors[index],
                newData = <span style="color:#00f">new</span> Uint8ClampedArray( item.data.length ),
                i = 0, l = item.data.length;

            <span style="color:#00f">for</span>( ; i &lt; l; i += 4 ){
                <span style="color:#00f">var</span> r = item.data[i];
                <span style="color:#00f">var</span> g = item.data[i+1];
                <span style="color:#00f">var</span> b = item.data[i+2];
                <span style="color:#00f">var</span> a = item.data[i+3];
                <span style="color:#00f">if</span>( r === 0 &amp;&amp; g === 255 &amp;&amp; b === 0 ){
                    newData[i] = newColor.r;
                    newData[i+1] = newColor.g;
                    newData[i+2] = newColor.b;
                    newData[i+3] = a;
                }<span style="color:#00f">else</span>{
                    newData[i] = r;
                    newData[i+1] = g;
                    newData[i+2] = b;
                    newData[i+3] = a;
                }
            }
            console.log(<span style="color:#a31515">&#34;[WORKER][WALL&#34;</span>+index+<span style="color:#a31515">&#34;] Finish painting&#34;</span>);
            <span style="color:#00f">return</span> <span style="color:#00f">new</span> ImageData(newData, item.width, item.height);
        });

        console.log(<span style="color:#a31515">&#34;[WORKER] Post back data&#34;</span>);
        self.postMessage({
            action : <span style="color:#a31515">&#39;UPDATE&#39;</span>,
            data : returnData
        })
    }
};

self.addEventListener(<span style="color:#a31515">&#39;message&#39;</span>, <span style="color:#00f">function</span>( evt ){
    <span style="color:#00f">var</span> data = evt.data;
    <span style="color:#00f">if</span>( Handler.hasOwnProperty( data.action ) ){
        Handler[ data.action ].call(Handler, data.data);
    }
})
</code></pre></div>
<h2 id="final-thoughts">Final thoughts</h2>

<p>This is not the best way to accomplish this task, but i think it shows the power the web have nowadays, and it also is IMHO a good example use case of the proposed <a href="https://developer.mozilla.org/es/docs/Web/API/OffscreenCanvas">OffScreenCanvas</a> which would allow this app to run almost entirely in the worker.</p>

</section>
</article>
</body>
</html>
