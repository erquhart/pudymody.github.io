<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="The other day, i was with a friend and after a few beers, the idea of resizing every cell to a 1x1 pixel size in an excel file and styling its background to match a pixel in an image came out. Loving to make apps and script without any sense, i decided to make a web app who would do it. So this post is going to be about its making." />
    <meta property="og:site_name" content="Federico Scodelaro" />
    <meta property="og:title" content="Making images with an excel file | Federico Scodelaro"/>
    <meta property="og:description" content="The other day, i was with a friend and after a few beers, the idea of resizing every cell to a 1x1 pixel size in an excel file and styling its background to match a pixel in an image came out. Loving to make apps and script without any sense, i decided to make a web app who would do it. So this post is going to be about its making." />
    <meta property="og:image" content="https://pudymody.github.io/static/me.jpg" />
    <meta property="og:url" content="https://pudymody.github.io/blog/2016-09-07-making-images-with-an-excel-file/" >
    <meta property="og:type" content="blog" />
    
      <meta property="article:published_time" content="2016-09-07 00:00:00 &#43;0000 UTC">
    
    <title>Making images with an excel file | Federico Scodelaro</title>
    <link rel="stylesheet" href="https://pudymody.github.io/static/tufte.min.css" />
    <link rel="shortcut icon" href="https://pudymody.github.io/static/favicon.png" type="image/png">
    <link rel="alternate" type="application/rss+xml" title="RSS" href="https://pudymody.github.io/index.xml">
  </head>

  <body>
    <header>
      <nav>
        <ul>
          
          
          <li>
            <a href="https://pudymody.github.io/">/home/federico scodelaro</a>
          </li>
          -
          <li>
            <a target="_blank" rel="noopener" href="https://github.com/pudymody">Github</a>
          </li>
          -
          <li>
            <a target="_blank" rel="noopener" href="https://telegram.me/pudymody">Telegram</a>
          </li>
          -
          <li>
            <a target="_blank" rel="noopener" href="mailto:federicoscodelaro@gmail.com">Email</a>
          </li>
          -
          

          
          
          <li>
            <a href="/index.xml">~/subscribe</a>
          </li>
          
        </ul>
      </nav>
    </header>
    <article>
<section>
<h1>Making images with an excel file</h1>
<p class="subtitle">2016/09/07</p>





<p>The other day, i was with a friend and after a few beers, the idea of resizing every cell to a 1x1 pixel size in an excel file and styling its background to match a pixel in an image came out. Loving to make apps and script without any sense, i decided to make a web app who would do it. So this post is going to be about its making.</p>

<p>You can use it right now from your browser <a href="https://pudymody.github.io/image-to-excel-grid/">here</a> and this is what you get using the classical lenna image (<em>i like showing the final product first</em>)
<img src="http://i.imgur.com/NznlVm1.jpg" alt="Example" /></p>

<p>In this post we&rsquo;re going to use the following Apis, you only need to know the basics</p>

<ul>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Using_web_workers">WebWorkers</a></li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise">Promises</a></li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/API/Canvas_API">Canvas</a></li>
</ul>

<p>First of all, we are going to make an input to select our image, and include our js file and a little modified version of <a href="https://github.com/SheetJS/js-xlsx">JS-xlsx</a></p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html">&lt;label for=<span style="color:#a31515">&#34;file&#34;</span> class=<span style="color:#a31515">&#34;btn btn--upload&#34;</span>&gt;
	&lt;input type=<span style="color:#a31515">&#34;file&#34;</span> id=<span style="color:#a31515">&#34;file&#34;</span>&gt;
	Please, select your image.
&lt;/label&gt;
&lt;script src=<span style="color:#a31515">&#34;app.js&#34;</span> charset=<span style="color:#a31515">&#34;utf-8&#34;</span>&gt;&lt;/script&gt;
&lt;script src=<span style="color:#a31515">&#34;xlsx.core.min.js&#34;</span> charset=<span style="color:#a31515">&#34;utf-8&#34;</span>&gt;&lt;/script&gt;</code></pre></div>
<p>Now, in our app.js file, first we are going to get a reference to our input and create a new instance of our WebWorker</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#00f">var</span> $file = document.querySelector(<span style="color:#a31515">&#39;input&#39;</span>);
<span style="color:#00f">var</span> imageWorker = <span style="color:#00f">new</span> Worker(<span style="color:#a31515">&#39;worker.js&#39;</span>);</code></pre></div>
<p>Then we are going to listen for the <em>change</em> event in our input, get its first file, and call our <em>makeCanvas</em> function which will return a <em>promise</em> with a canvas with the image drawn on it. Then we are going to pass the imageData of our canvas into our WebWorker</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#00f">function</span> makeCanvas( file ){
	<span style="color:#00f">return</span> <span style="color:#00f">new</span> Promise(<span style="color:#00f">function</span>( resolve, reject ){
		<span style="color:#00f">var</span> url = URL.createObjectURL(file);
		<span style="color:#00f">var</span> img = <span style="color:#00f">new</span> Image();
		img.onload = <span style="color:#00f">function</span>(){
			<span style="color:#00f">var</span> canvas = document.createElement(<span style="color:#a31515">&#39;canvas&#39;</span>);
				canvas.width = <span style="color:#00f">this</span>.width;
				canvas.height = <span style="color:#00f">this</span>.height;

			<span style="color:#00f">var</span> ctx = canvas.getContext(<span style="color:#a31515">&#39;2d&#39;</span>);
			ctx.drawImage( <span style="color:#00f">this</span>, 0, 0 );
			URL.revokeObjectURL( <span style="color:#00f">this</span>.src );
			resolve(canvas);
		};
		img.onerror = reject;
		img.src = url;
	});
}

$file.addEventListener(<span style="color:#a31515">&#39;change&#39;</span>, <span style="color:#00f">function</span>(e){
	document.body.classList.add(<span style="color:#a31515">&#39;is-loading&#39;</span>);
	<span style="color:#00f">var</span> file = e.target.files[0];
	makeCanvas(file)
		.then(<span style="color:#00f">function</span>( canvas ){
			<span style="color:#00f">var</span> imageData = canvas.getContext(<span style="color:#a31515">&#39;2d&#39;</span>).getImageData(0,0, canvas.width, canvas.height );
			imageWorker.postMessage(imageData);
		})
		.<span style="color:#00f">catch</span>(console.error);
});</code></pre></div>
<h2 id="webworker-code">WebWorker code</h2>

<p>Now here is where all the magic happens, first we need to create a new file called <em>worker.js</em>. There we are going to make two functions which will help us convert colors from rgb to hex and import our <em>js-xlsx</em> file</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js">importScripts(<span style="color:#a31515">&#34;xlsx.core.min.js&#34;</span>);
<span style="color:#00f">function</span> componentToHex(c) {
    <span style="color:#00f">var</span> hex = c.toString(16);
    <span style="color:#00f">return</span> hex.length == 1 ? <span style="color:#a31515">&#34;0&#34;</span> + hex : hex;
}

<span style="color:#00f">function</span> rgbToHex(r, g, b) {
    <span style="color:#00f">return</span> componentToHex(r) + componentToHex(g) + componentToHex(b);
}</code></pre></div>
<p>Then we are going to attach a function to be executed everytime we get data into our webworker.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js">self.onmessage = <span style="color:#00f">function</span>(){}</code></pre></div>
<p><strong>The following code is going to be inside in our <em>onmessage</em> function, i&rsquo;ve stripped it to explain it piece by piece</strong></p>

<p>First of all, we get our imageData passed, which is a flatten array, and convert it to an array of objects with its rgba values separated</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#00f">var</span> data = e.data;
<span style="color:#00f">var</span> parsed = { height : data.height, width : data.width, data : [] };
<span style="color:#00f">for</span>( <span style="color:#00f">var</span> i = 0, l = data.data.length; i &lt; l; i+=4){
	parsed.data.push({
		r : data.data[i],
		g : data.data[i+1],
		b : data.data[i+2],
		a : data.data[i+3]
	});
}</code></pre></div>
<p>Now we need to make our spreadsheet object. To do this, first we are going to figure out in wich row and column we are. Then we convert this to a valid cell id, and set it as the key in our object and its value to a style with our pixel color as background. The &ldquo;official&rdquo; version of js-xlsx doesnt allow custom styles to be set, so i have to use <a href="https://github.com/protobi/js-xlsx">protobi&rsquo;s version</a></p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#00f">var</span> dataFile = parsed.data.reduce(<span style="color:#00f">function</span>( prev, current, index ){
	<span style="color:#00f">var</span> currentRow = Math.floor(index <span style="">/ parsed.width);</span>
	<span style="color:#00f">var</span> currentColumn = index % (parsed.width);

	<span style="color:#00f">var</span> id = XLSX.utils.encode_cell({ c: currentColumn , r: currentRow});
	prev[id] = {
		t : <span style="color:#a31515">&#39;s&#39;</span>,
		v : <span style="color:#a31515">&#34;&#34;</span>,
		s : {
			fill : {
				patternType : <span style="color:#a31515">&#34;solid&#34;</span>,
				fgColor : { rgb: rgbToHex(current.r, current.g, current.b) },
				width: 2
			}
		}
	};

	<span style="color:#00f">return</span> prev;
}, {});</code></pre></div>
<p>Now we need to set our range of cells, and set the column width to be 1px. As neither of two allow us to set our row height, i have to edit the file and set it manually, so no step for this. We also need to make our workbook object, which is going to be written.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js">dataFile[<span style="color:#a31515">&#34;!ref&#34;</span>] = XLSX.utils.encode_range({
	s : { c: 0, r: 0},
	e : { c: data.width - 1, r: data.height - 1},
});

dataFile[<span style="color:#a31515">&#34;!cols&#34;</span>] = [];
<span style="color:#00f">for</span>( <span style="color:#00f">var</span> i = 0; i &lt; data.width; i++){
	dataFile[<span style="color:#a31515">&#34;!cols&#34;</span>].push({
		wpx : 1
	});
}

<span style="color:#00f">var</span> wb = {
	SheetNames : [<span style="color:#a31515">&#34;Image&#34;</span>],
	Sheets : {
		<span style="color:#a31515">&#34;Image&#34;</span> : dataFile
	}
};</code></pre></div>
<p>Finally, we write our wokbook, create a blob for it and a url which is going to be passed to our main thread.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#00f">function</span> s2ab(s) {
  <span style="color:#00f">var</span> buf = <span style="color:#00f">new</span> ArrayBuffer(s.length);
  <span style="color:#00f">var</span> view = <span style="color:#00f">new</span> Uint8Array(buf);
  <span style="color:#00f">for</span> (<span style="color:#00f">var</span> i=0; i!=s.length; ++i) view[i] = s.charCodeAt(i) &amp; 0xFF;
  <span style="color:#00f">return</span> buf;
}

<span style="color:#00f">var</span> wbout = XLSX.write(wb, {bookType:<span style="color:#a31515">&#39;xlsx&#39;</span>, bookSST:<span style="color:#00f">true</span>, type: <span style="color:#a31515">&#39;binary&#39;</span>});
<span style="color:#00f">var</span> blob = <span style="color:#00f">new</span> Blob([s2ab(wbout)], {type : <span style="color:#a31515">&#34;application/octet-stream&#34;</span>});
<span style="color:#00f">var</span> url = URL.createObjectURL(blob);
postMessage(url);</code></pre></div>
<p>Our final step is to handle our data back from the worker so in our app.js file we need to listen for the onmessage event. What we are only doing here is creating a new <em>a</em> tag with the url to our workbook&rsquo;s blob and appending it to the body.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js">imageWorker.onmessage = <span style="color:#00f">function</span>(e){
	<span style="color:#00f">var</span> a = document.createElement(<span style="color:#a31515">&#39;a&#39;</span>);
		a.download = <span style="color:#a31515">&#34;image.xlsx&#34;</span>;
		a.href = e.data;
		a.innerText = <span style="color:#a31515">&#34;Download image&#34;</span>;
		a.className = <span style="color:#a31515">&#34;btn btn--download&#34;</span>;
	document.body.appendChild(a);
	document.body.classList.remove(<span style="color:#a31515">&#39;is-loading&#39;</span>);
};</code></pre></div>
<p>And thats all the magic you need to know!</p>

<p><em>PD: Yes, i know i could use Service Workers to make it a fully operational web app, but thats not the point of the post</em></p>

<p><em>PD II: Yes, i also know that i could use webworkers in previous posts, but i dont know why i didnt</em></p>

</section>
</article>
</body>
</html>